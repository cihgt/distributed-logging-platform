FROM golang:1.24 AS builder

WORKDIR /app

COPY collector/go.mod collector/go.sum ./
COPY proto ./proto
RUN go mod tidy

COPY . .

WORKDIR /app/collector

# üëá –°—Ç–∞—Ç–∏—á–µ—Å–∫–∞—è —Å–±–æ—Ä–∫–∞ ‚Äî —ç—Ç–æ –Ω–∞—à–µ —Å–ø–∞—Å–µ–Ω–∏–µ –æ—Ç /libc.so.6
RUN CGO_ENABLED=0 GOOS=linux GOARCH=amd64 go build -a -o collector

# üëá –ü—É—Å—Ç–æ–π –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –æ–±—Ä–∞–∑ –±–µ–∑ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
FROM scratch

WORKDIR /root/
COPY --from=builder /app/collector/collector .

EXPOSE 50051 9090
ENTRYPOINT ["/root/collector"]
